var AssetAdapter=function(){function e(){}var t=(__define,e),n=t.prototype;return n.getAsset=function(e,t,n){function i(i){t.call(n,i,e)}if(RES.hasRes(e)){var s=RES.getRes(e);s?i(s):RES.getResAsync(e,i,this)}else RES.getResByUrl(e,i,this,RES.ResourceItem.TYPE_IMAGE)},e}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var n=(__define,t),i=n.prototype;return i.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},i.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var GameObject=function(){function e(){this.m_x=0,this.m_y=0}var t=__define,n=e,i=n.prototype;return i.destroy=function(){null!=this.m_skin&&(this.m_skin.destroy(),this.m_skin=null)},i.getIndex=function(){return new egret.Point(this.m_x,this.m_y)},i.getSkinName=function(){return this.m_skin?this.m_skin.getSkinName():""},i.setSkin=function(e){this.m_skin=e},t(i,"x",void 0,function(t){this.m_x=t,this.m_skin.x=t*e.ICON_WIDTH}),t(i,"y",void 0,function(t){this.m_y=t,this.m_skin.y=t*e.ICON_HEIGHT}),e.ICON_WIDTH=31,e.ICON_HEIGHT=31,e}();egret.registerClass(GameObject,"GameObject");var GameState=function(){function e(){this.num_col=10,this.num_row=12}var t=(__define,e),n=t.prototype;return n.onEnter=function(){Main.setDebugInfo("Debug enter game state"),UIManager.Instance.openUI(4),this.m_gameScene=new GameScene(this.num_col,this.num_row)},n.onExit=function(){this.m_gameScene=null,UIManager.Instance.closeUI(4)},n.onUpdate=function(e){null!=this.m_gameScene&&this.m_gameScene.onUpdate(e)},n.toString=function(){return"GameState"},e}();egret.registerClass(GameState,"GameState",["IGameState"]);var GameStateMgr=function(){function e(){}var t=__define,n=e,i=n.prototype;return t(e,"Instance",function(){return Main.setDebugInfo("DebugABC create state instance"),null==e.m_instance&&(Main.setDebugInfo("new create state instance"),e.m_instance=new e,Main.setDebugInfo("init create state instance"),e.m_instance.init(),Main.setDebugInfo("successfully create state instance")),Main.setDebugInfo(null==e.m_instance?"fuck":"yes!"),e.m_instance}),i.init=function(){Main.setDebugInfo("prenewMapABC create state instance"),this.m_states=[],Main.setDebugInfo("newMap create state instance"),this.m_states[1]=new GameState,Main.setDebugInfo("new GameState"),this.m_states[0]=new StartState,Main.setDebugInfo("new StartState")},i.update=function(){null!=this.m_currentState&&this.m_currentState.onUpdate(egret.getTimer())},i.changeState=function(e){null!=this.m_currentState&&this.m_currentState.onExit();var t=this.m_states[e];null!=t?(Main.setDebugInfo("Debug change state"),Main.setDebugInfo(t.toString()),Main.setDebugInfo(e.toString()),t.onEnter(),this.m_currentState=t):Main.setDebugInfo("Debug cant find state")},e.m_instance=null,e}();egret.registerClass(GameStateMgr,"GameStateMgr");var StartState=function(){function e(){}var t=(__define,e),n=t.prototype;return n.onEnter=function(){Main.setDebugInfo("Debug enter startState"),UIManager.Instance.openUI(0)},n.onUpdate=function(e){},n.onExit=function(){UIManager.Instance.closeUI(0),Main.setDebugInfo("Debug exit startState")},n.toString=function(){return"StartState"},e}();egret.registerClass(StartState,"StartState",["IGameState"]);var Main=function(e){function t(){e.apply(this,arguments),this.isThemeLoadEnd=!1,this.isResourceLoadEnd=!1}__extends(t,e);var n=(__define,t),i=n.prototype;return i.createChildren=function(){e.prototype.createChildren.call(this);var n=new AssetAdapter;this.stage.registerImplementation("eui.IAssetAdapter",n),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),this.stage.addChild(t.tf),t.tf.textColor=16711680,t.tf.visible=!1,RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},t.setDebugInfo=function(e){t.tf.text=e,t.tf.width=t.tf.textWidth+10},i.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var t=new eui.Theme("resource/default.thm.json",this.stage);t.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},i.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},i.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoadEnd=!0,this.createScene())},i.createScene=function(){this.isThemeLoadEnd&&this.isResourceLoadEnd&&this.startCreateScene()},i.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},i.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},i.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},i.startCreateScene=function(){var e=new eui.Button;e.label="Click!",e.horizontalCenter=0,e.verticalCenter=0,this.addChild(e),e.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonClick,this)},i.onButtonClick=function(e){t.setDebugInfo("Debug click btn");var n=e.target;null!=n&&(n.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonClick,this),this.removeChild(n),n=null),UIManager.Instance.Root=this,GameStateMgr.Instance.changeState(0),this.stage.addEventListener(egret.Event.ENTER_FRAME,function(e){GameStateMgr.Instance.update()},this)},t.tf=new egret.TextField,t}(eui.UILayer);egret.registerClass(Main,"Main");var GameScene=function(){function e(e,t){if(this.m_score=0,this.m_gamePause=!1,this.m_autoDropCacheTime=0,this.m_autoDropCacheSwitch=!1,this.MAX_TIME=120,this.m_timeDT=0,this.CURRENT_TIME=this.MAX_TIME,this.LEVEL=2,this.MAX_LEVEL=10,this.ICON_NUM=1,this.ICON_DROP_SPEED=1e3,this.m_remainDropList=[],this.m_mapIconList=[],this.m_mapIconData=[],this.m_touchBeginPos=new egret.Point,this.m_touchEndPos=new egret.Point,this.m_sceneUI=UIManager.Instance.getOpenedUI(4),egret.Capabilities.isMobile)this.m_sceneUI.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouch,this),this.m_sceneUI.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouch,this);else{var n=this;document.addEventListener("keydown",function(e){n.onKeyBoard(e)})}this.m_col=e,this.m_row=t,this.m_timer=new egret.Timer(this.ICON_DROP_SPEED),this.m_timer.addEventListener(egret.TimerEvent.TIMER,this.onTimer,this),this.reset()}var t=(__define,e),n=t.prototype;return n.gamewin=function(){},n.gameover=function(){this.m_gamePause=!0,this.m_timer.stop(),this.LEVEL=this.LEVEL++%this.MAX_LEVEL+1,this.ICON_NUM=this.ICON_NUM++%this.m_row+1,this.CURRENT_TIME=this.MAX_TIME*this.LEVEL},n.reset=function(){this.m_gamePause=!1,this.m_timer.start(),this.m_mapIconData=[],this.m_mapIconList=[],this.m_remainDropList=[],this.createScene(this.m_col,this.m_row),this.createMapData()},n.startCountAutoDropTime=function(){this.m_autoDropCacheSwitch=!0,this.m_autoDropCacheTime=egret.getTimer()},n.closeCountAutoDrop=function(){this.m_timer.delay=this.ICON_DROP_SPEED,this.m_autoDropCacheSwitch=!1},n.onUpdate=function(e){this.onCountTimer(e),this.m_autoDropCacheSwitch&&e-this.m_autoDropCacheTime>1e3&&this.m_timer.delay==this.ICON_DROP_SPEED&&(this.m_timer.delay=66.6)},n.destroy=function(){null!=this.m_timer&&(this.m_timer.removeEventListener(egret.TimerEvent.TIMER,this.onTimer,this),this.m_timer=null),null!=this.m_sceneUI&&(this.m_sceneUI.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouch,this),this.m_sceneUI.stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouch,this),this.m_sceneUI=null)},n.onTouch=function(e){if(!this.m_gamePause){var t=!1;switch(e.type){case"touchBegin":this.m_touchBeginPos.x=e.localX,this.m_touchBeginPos.y=e.localY,this.startCountAutoDropTime();break;case"touchEnd":this.m_touchEndPos.x=e.localX,this.m_touchEndPos.y=e.localY,this.closeCountAutoDrop(),t=!0}if(t){var n=this.m_touchBeginPos.x-this.m_touchEndPos.x,i=this.m_touchBeginPos.y-this.m_touchEndPos.y,s=this.m_currentControlItem.getIndex(),r=!1;Math.abs(n)>GameObject.ICON_WIDTH&&(n>0?s.x-=1:s.x+=1),Math.abs(i)>GameObject.ICON_HEIGHT&&(i>0||(s.y+=1,r=!0)),this.moveCurrentIcon(s,r)}}},n.moveCurrentIcon=function(e,t){this.checkBound(e)&&(this.checkBlock(e)?t&&(this.calcScore(this.m_currentControlItem),this.m_currentControlItem=null):(this.deleteIconPosData(this.m_currentControlItem),this.m_currentControlItem.x=e.x,this.m_currentControlItem.y=e.y,this.addIconPosData(this.m_currentControlItem)))},n.onKeyBoard=function(e){if(null!=this.m_currentControlItem&&!this.m_gamePause){var t=this.m_currentControlItem.getIndex(),n=!1;switch(e.keyCode){case 37:t.x-=1;break;case 38:t.y-=1;break;case 39:t.x+=1;break;case 40:t.y+=1,n=!0}this.moveCurrentIcon(t,n)}},n.findSameSkinByDir=function(e,t,n){if(null!=GameObject){var i=e.getIndex(),s={x:i.x+t.x,y:i.y+t.y};if(this.checkBound(s)){var r=this.m_mapIconData[s.x][s.y];if(-1==n.indexOf(r))for(;null!=r&&r.getSkinName()==e.getSkinName();)if(n.push(r),this.findSameTarget(r,n),s.x+=t.x,s.y+=t.y,r=null,this.checkBound(s)&&(r=this.m_mapIconData[s.x][s.y],-1!=n.indexOf(r)))return}}},n.checkBound=function(e){return e.x<0||e.x>=this.m_col||e.y<0||e.y>=this.m_row?!1:!0},n.checkBlock=function(e){return this.checkBound(e)?null!=this.m_mapIconData[e.x][e.y]:!0},n.getIcon=function(e,t){return this.m_mapIconData[e][t]},n.onTimer=function(e){this.onCreateNewDropItem(),this.onRemainListDrop()},n.onRemainListDrop=function(){for(var e in this.m_remainDropList){var t=this.m_remainDropList[e],n=t.getIndex(),i=new egret.Point(n.x,n.y+1);if(this.checkBlock(i)){this.calcScore(t);var s=this.m_remainDropList.indexOf(t);return void(-1!=s&&this.m_remainDropList.splice(s,1))}this.deleteIconPosData(t),t.x=i.x,t.y=i.y,this.addIconPosData(t)}},n.onCreateNewDropItem=function(){var e=this.m_remainDropList.length;if(!(e>0)){if(null==this.m_currentControlItem){var t=Math.ceil((this.m_col-1)*Math.random()),n=0;return this.m_currentControlItem=this.m_sceneUI.createIcon(t,n,this.LEVEL),this.m_mapIconData[t][n]=this.m_currentControlItem,this.m_mapIconList.push(this.m_currentControlItem),void this.closeCountAutoDrop()}var i=this.m_currentControlItem.getIndex(),s=new egret.Point(i.x,i.y+1);this.checkBlock(s)?(this.calcScore(this.m_currentControlItem),this.m_currentControlItem=null):(this.deleteIconPosData(this.m_currentControlItem),this.m_currentControlItem.x=s.x,this.m_currentControlItem.y=s.y,this.addIconPosData(this.m_currentControlItem))}},n.calcScore=function(e){var t=[e];this.findSameTarget(e,t),console.log(t.toString());var n=t.length;if(n>=3){for(this.m_score+=n;t.length;){var i=t.pop(),s=i.getIndex();this.m_sceneUI.createParticle(s.x*GameObject.ICON_WIDTH+GameObject.ICON_WIDTH/2,s.y*GameObject.ICON_HEIGHT+GameObject.ICON_HEIGHT/2),this.deleteIconPosData(i);var r=this.m_mapIconList.indexOf(i);-1!=r&&this.m_mapIconList.splice(r,1),i.destroy()}this.m_sceneUI.setScore(this.m_score),this.m_mapIconList.length>0?(this.m_remainDropList=[],this.findRemainIcon(this.m_remainDropList)):(this.gameover(),this.reset())}},n.findRemainIcon=function(e){for(var t in this.m_mapIconList){for(var n=this.m_mapIconList[t],i=n.getIndex(),s=!1;i.y++<this.m_row;)if(!this.checkBlock(i)){s=!0;break}s&&e.push(n)}},n.findSameTarget=function(t,n){this.findSameSkinByDir(t,e.SEARCH_LEFT,n),this.findSameSkinByDir(t,e.SEARCH_UP,n),this.findSameSkinByDir(t,e.SEARCH_RIGHT,n),this.findSameSkinByDir(t,e.SEARCH_DOWN,n)},n.deleteIconPosData=function(e){var t=e.getIndex();this.m_mapIconData[t.x][t.y]=null},n.addIconPosData=function(e){var t=e.getIndex();this.m_mapIconData[t.x][t.y]=e},n.onCountTimer=function(e){if(!this.m_gamePause&&e-this.m_timeDT>1e3){if(this.m_timeDT=e,--this.CURRENT_TIME<0)return void this.gameover();this.m_sceneUI.setTime(this.CURRENT_TIME)}},n.createScene=function(e,t){null!=this.m_sceneUI&&this.m_sceneUI.createScene(e,t)},n.createMapData=function(){for(var e=0;e<this.m_col;e++){this.m_mapIconData[e]=[];for(var t=0;t<this.m_row;t++)if(t<this.m_row-this.ICON_NUM);else{var n=this.m_sceneUI.createIcon(e,t,this.LEVEL);this.m_mapIconData[e][t]=n,this.m_mapIconList.push(n)}}},e.SEARCH_LEFT=new egret.Point(-1,0),e.SEARCH_RIGHT=new egret.Point(1,0),e.SEARCH_UP=new egret.Point(0,-1),e.SEARCH_DOWN=new egret.Point(0,1),e}();egret.registerClass(GameScene,"GameScene");var UIManager=function(){function e(){}var t=__define,n=e,i=n.prototype;return t(e,"Instance",function(){return null==this.m_instance&&(this.m_instance=new e,this.m_instance.init()),this.m_instance}),i.init=function(){this.m_ui=[],this.m_uiSkin=[],this.m_uiSkin[0]="resource/eui_skins/StartPanelSkin.exml",this.m_uiSkin[4]="resource/eui_skins/GameSceneSkin.exml"},t(i,"Root",function(){return this.m_root},function(e){this.m_root=e}),i.openUI=function(e){if(Main.setDebugInfo("open UI"),null!=this.m_root){Main.setDebugInfo("root UI");var t;switch(e){case 0:t=new StartPanelUI,Main.setDebugInfo("create startUI");break;case 1:break;case 2:break;case 3:break;case 4:t=new GameSceneUI}null!=t&&(t.skinName=this.m_uiSkin[e],this.m_ui[e]=t,this.m_root.addChild(t))}},i.getOpenedUI=function(e){return this.m_ui[e]},i.closeUI=function(e){if(null!=this.m_root){var t=this.m_ui[e];null!=t&&(this.m_root.removeChild(t),delete this.m_ui[e])}},e}();egret.registerClass(UIManager,"UIManager");var ThemeAdapter=function(){function e(){}var t=(__define,e),n=t.prototype;return n.getTheme=function(e,t,n,i){function s(e){t.call(i,e)}function r(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),n.call(i))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),RES.getResByUrl(e,s,this,RES.ResourceItem.TYPE_TEXT)},e}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);var GameItemCountUI=function(e){function t(){e.call(this)}__extends(t,e);var n=(__define,t);n.prototype;return t}(eui.Component);egret.registerClass(GameItemCountUI,"GameItemCountUI");var GameItemUI=function(e){function t(){e.call(this)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.destroy=function(){var e=this.parent;null!=e&&e.removeChild(this)},i.setIcon=function(e){this.m_skin=e;var t=RES.getRes("poom_icon_spritesheet");null!=t&&(this.texture=t.getTexture(e))},i.getSkinName=function(){return this.m_skin},t}(egret.Bitmap);egret.registerClass(GameItemUI,"GameItemUI");var GameSceneUI=function(e){function t(){e.call(this),this.m_sprBackGround=new egret.Shape,this.m_sprIconContainer=new egret.DisplayObjectContainer,this.m_sprParticleContainer=new egret.DisplayObjectContainer,this.m_sprRootContainer=new egret.DisplayObjectContainer,this.addChild(this.m_sprRootContainer),this.m_sprRootContainer.addChild(this.m_sprBackGround),this.m_sprRootContainer.addChild(this.m_sprIconContainer),this.m_sprRootContainer.addChild(this.m_sprParticleContainer),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this),this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.onRemoveFromStage,this)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.onAddToStage=function(e){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this),null!=this.label_area&&(this.m_sprRootContainer.x=this.label_area.x,this.m_sprRootContainer.y=this.label_area.y,this.label_area.visible=!1)},i.onRemoveFromStage=function(e){this.removeEventListener(egret.Event.REMOVED_FROM_STAGE,this.onRemoveFromStage,this),null!=this.m_sprBackGround&&this.removeChild(this.m_sprBackGround)},i.createScene=function(e,t){if(null!=this.m_sprBackGround){this.m_sprBackGround.graphics.clear();for(var n=0;e>n;n++)for(var i=0;t>i;i++)this.m_sprBackGround.graphics.beginFill(16777215*Math.random(),.1),this.m_sprBackGround.graphics.lineStyle(1),this.m_sprBackGround.graphics.drawRect(n*GameObject.ICON_WIDTH,i*GameObject.ICON_HEIGHT,GameObject.ICON_WIDTH,GameObject.ICON_HEIGHT),this.m_sprBackGround.graphics.endFill()}},i.createParticle=function(e,t){var n=RES.getRes("snowBoom_png"),i=RES.getRes("snowBoom_json"),s=new particle.GravityParticleSystem(n,i);s.start(200),s.x=e,s.y=t,s.addEventListener(egret.Event.COMPLETE,this.removeParticle,this),this.m_sprParticleContainer.addChild(s)},i.removeParticle=function(e){this.m_sprParticleContainer.removeChild(e.target)},i.setScore=function(e){null!=this.eui_score&&this.eui_score.setData(e.toString())},i.setTime=function(e){null!=this.eui_time&&this.eui_time.setData(e.toString())},i.createIcon=function(e,t,n){var i=new GameObject,s=new GameItemUI;return s.setIcon(Math.ceil(Math.random()*n).toString()),i.setSkin(s),i.x=e,i.y=t,this.m_sprIconContainer.addChild(s),i},t}(eui.Component);egret.registerClass(GameSceneUI,"GameSceneUI");var GameScoreUI=function(e){function t(){e.call(this)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.setData=function(e){null!=this.label_data&&(this.label_data.text=e)},t}(eui.Component);egret.registerClass(GameScoreUI,"GameScoreUI");var GameTimerUI=function(e){function t(){e.call(this)}__extends(t,e);var n=(__define,t);n.prototype;return t}(GameScoreUI);egret.registerClass(GameTimerUI,"GameTimerUI");var StartPanelUI=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddtoStage,this),this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.onRemoveFromStage,this),UIManager.Instance.Root.stage.addEventListener(egret.Event.RESIZE,this.onResize,this)}__extends(t,e);var n=__define,i=t,s=i.prototype;return s.onResize=function(e){var t=UIManager.Instance.Root;this.x=t.width-this.width>>1,this.y=t.height-this.height>>1},s.onRemoveFromStage=function(e){this.removeEventListener(egret.Event.REMOVED_FROM_STAGE,this.onRemoveFromStage,this),this.btn_enter.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onClickEnter,this),UIManager.Instance.Root.removeEventListener(egret.Event.RESIZE,this.onResize,this)},s.onAddtoStage=function(e){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.onAddtoStage,this),this.btn_enter.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClickEnter,this),this.Label_Tittle.text="很不科学",this.label_info.text="大壮试玩版";var t=UIManager.Instance.Root;this.x=t.width-this.width>>1,this.y=t.height-this.height>>1},s.onClickEnter=function(e){console.log("i dont like it"),GameStateMgr.Instance.changeState(1)},n(s,"Label_Tittle",function(){return this.label_tittle}),n(s,"Label_Info",function(){return this.label_info}),n(s,"Btn_Enter",function(){return this.btn_enter}),t}(eui.Component);egret.registerClass(StartPanelUI,"StartPanelUI");